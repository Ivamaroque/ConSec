<div class="dashboard-layout">
  <!-- Sidebar ESQUERDA - Menu de Navegação -->
  <aside class="sidebar-left">
    <div class="sidebar-logo">
      <span class="material-icons">account_balance_wallet</span>
      <h5>ConSec</h5>
    </div>

    <nav class="sidebar-nav">
      <a href="/dashboard" class="nav-item active">
        <span class="material-icons">dashboard</span>
        <span>Dashboard</span>
      </a>
      <a href="/gerenciar-temas" class="nav-item">
        <span class="material-icons">label</span>
        <span>Gerenciar Temas</span>
      </a>
      <a href="/gerenciar-funcionarios" class="nav-item">
        <span class="material-icons">people</span>
        <span>Gerenciar Funcionários</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a (click)="logout()" class="nav-item logout-btn">
        <span class="material-icons">logout</span>
        <span>Sair</span>
      </a>
    </div>
  </aside>

  <!-- Área CENTRAL - Dashboard Principal -->
  <main class="dashboard-main">
    <div class="main-header">
      <h4>Dashboard</h4>
      <div class="header-filters">
        <span>Mês:</span>
        <select class="form-select form-select-sm">
          <option>Dezembro</option>
        </select>
        <span>Ano:</span>
        <select class="form-select form-select-sm">
          <option>2025</option>
        </select>
      </div>
    </div>

    <!-- Mensagem de erro -->
    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ errorMessage }}
      <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
    </div>

    <!-- Cards de Resumo -->
    <div class="summary-cards" *ngIf="resumo">
      <div class="summary-card">
        <div class="summary-card-header">Total disponível</div>
        <div class="summary-card-value text-success">R$ 2500,00</div>
      </div>
      <div class="summary-card">
        <div class="summary-card-header">Total gasto</div>
        <div class="summary-card-value text-danger">{{ formatCurrency(resumo.totalGeral) }}</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section mb-4">
      <h6 class="mb-3">Visualizar por Mês:</h6>
      <div class="d-flex gap-3 align-items-end">
        <div>
          <label class="form-label small">Data Início</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="filtros.dataInicio">
        </div>
        <div>
          <label class="form-label small">Data Fim</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="filtros.dataFim">
        </div>
        <div>
          <label class="form-label small">Categoria</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.temaCustoId">
            <option [ngValue]="null">Todas</option>
            <option *ngFor="let tema of temas" [ngValue]="tema.id">{{ tema.nome }}</option>
          </select>
        </div>
        <div>
          <label class="form-label small">Ano</label>
          <select class="form-select form-select-sm">
            <option>2025</option>
          </select>
        </div>
        <button class="btn btn-primary btn-sm" (click)="aplicarFiltros()" [disabled]="loading">
          <span class="material-icons">search</span> Filtrar
        </button>
        <button class="btn btn-outline-secondary btn-sm" (click)="limparFiltros()" [disabled]="loading">
          <span class="material-icons">cancel</span> Limpar
        </button>
      </div>
    </div>

    <!-- Gráficos lado a lado -->
    <div class="charts-grid" *ngIf="resumo">
      <!-- Gráfico de Pizza -->
      <div class="chart-section">
        <h6 class="mb-3"><span class="material-icons">pie_chart</span> Gastos por Categoria</h6>
        <div class="pie-chart-container">
          <div *ngIf="resumo.porTema.length > 0" class="pie-chart-wrapper">
            <canvas #pieChartCanvas></canvas>
          </div>
          <div *ngIf="resumo.porTema.length === 0" class="text-center text-muted">
            <span class="material-icons fs-1">pie_chart</span>
            <p class="mt-2">Nenhum dado disponível</p>
          </div>
        </div>
      </div>

      <!-- Gráfico de Barras - Gastos por Dia -->
      <div class="chart-section">
        <h6 class="mb-3"><span class="material-icons">bar_chart</span> Gastos por Dia do Mês</h6>
        <div class="bar-chart-container">
          <div *ngIf="gastoPorDia.length > 0" class="bar-chart-wrapper">
            <canvas #barChartCanvas></canvas>
          </div>
          <div *ngIf="gastoPorDia.length === 0" class="text-center text-muted">
            <span class="material-icons fs-1">bar_chart</span>
            <p class="mt-2">Nenhum dado disponível</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico de Funcionários -->
    <div class="chart-section mb-4" *ngIf="resumo">
      <h6 class="mb-3"><span class="material-icons">people</span> Gastos por Funcionário</h6>
      <div *ngIf="resumo.porUsuario.length > 0" class="table-responsive">
        <table class="table table-hover table-sm mb-0">
          <thead>
            <tr>
              <th>Funcionário</th>
              <th class="text-end">Total</th>
              <th class="text-end">Quantidade</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of resumo.porUsuario">
              <td><span class="material-icons">account_circle</span> {{ usuario.usuarioNome }}</td>
              <td class="text-end fw-bold">{{ formatCurrency(usuario.total) }}</td>
              <td class="text-end"><span class="badge bg-secondary">{{ usuario.quantidade }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="resumo.porUsuario.length === 0" class="text-center text-muted py-3">
        <p>Nenhum funcionário com gastos</p>
      </div>
    </div>

    <!-- Evolução Mensal -->
    <div class="chart-section mb-4" *ngIf="resumo">
      <h6 class="mb-3"><span class="material-icons">calendar_month</span> Evolução Mensal</h6>
      <div *ngIf="resumo.porMes.length > 0" class="table-responsive">
        <table class="table table-hover table-sm mb-0">
          <thead>
            <tr>
              <th>Mês</th>
              <th class="text-end">Total</th>
              <th class="text-end">Quantidade</th>
              <th class="text-end">Média</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let mes of resumo.porMes">
              <td><span class="material-icons">event</span> <strong>{{ mes.mes }}</strong></td>
              <td class="text-end fw-bold text-primary">{{ formatCurrency(mes.total) }}</td>
              <td class="text-end"><span class="badge bg-secondary">{{ mes.quantidade }}</span></td>
              <td class="text-end text-success">{{ formatCurrency(mes.total / mes.quantidade) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Sidebar DIREITA - Últimos Gastos -->
  <aside class="sidebar-right">
    <h6 class="sidebar-title">
      <span class="material-icons">receipt_long</span> Últimos gastos adicionados
    </h6>

    <div *ngIf="loading" class="text-center py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>

    <div *ngIf="!loading && custos.length === 0" class="text-center text-muted py-3">
      <small>Nenhum custo encontrado</small>
    </div>

    <div *ngIf="!loading && custos.length > 0" class="expense-list">
      <div *ngFor="let custo of custos.slice(0, 10)"
           class="expense-card">
        <!-- Aplicar cor dinamicamente -->
        <div class="expense-card-border" [style.background-color]="custo.temaCustoCor || '#667eea'"></div>
        <div class="expense-card-header">
          <div class="expense-tema-info">
            <span class="expense-tema" [style.color]="custo.temaCustoCor || '#667eea'">{{ custo.temaCustoNome }}</span>
            <span class="expense-separator">|</span>
            <span class="expense-author">{{ custo.usuarioNome || 'Não informado' }}</span>
          </div>
          <div class="expense-date">{{ formatDate(custo.dataPagamento) }}</div>
        </div>

        <div class="expense-card-body">
          <div class="expense-title">{{ custo.descricao }}</div>
          <div class="expense-price">{{ formatCurrency(custo.valor) }}</div>
        </div>

        <div class="expense-card-footer">
          <a *ngIf="custo.arquivoAnexoPath" (click)="downloadComprovante(custo)" class="expense-link">
            <span class="material-icons">insert_drive_file</span>
            Comprovante.{{ getFileExtension(custo.arquivoAnexoPath) }}
          </a>
          <span *ngIf="!custo.arquivoAnexoPath" class="expense-no-attachment">
            <span class="material-icons">description</span>
            Sem comprovante
          </span>
          <div class="expense-actions-icons" *ngIf="isAdmin">
            <button class="btn-icon-small" title="Editar" (click)="abrirModalEdicao(custo)">
              <span class="material-icons">edit</span>
            </button>
            <button class="btn-icon-small btn-icon-delete" title="Excluir" (click)="abrirModalExclusao(custo)">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Modal de Exclusão -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="fecharModalExclusao()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5><span class="material-icons">delete</span> Confirmar Exclusão</h5>
      <button class="btn-close-modal" (click)="fecharModalExclusao()">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir este custo?</p>
      <div class="delete-info" *ngIf="custoSelecionado">
        <strong>{{ custoSelecionado.descricao }}</strong>
        <p class="text-muted">{{ formatCurrency(custoSelecionado.valor) }}</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModalExclusao()">
        <span class="material-icons">close</span> Cancelar
      </button>
      <button class="btn btn-danger" (click)="confirmarExclusao()" [disabled]="loading">
        <span class="material-icons">delete</span> Excluir
      </button>
    </div>
  </div>
</div>

<!-- Modal de Edição -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="fecharModalEdicao()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5><span class="material-icons">edit</span> Editar Custo</h5>
      <button class="btn-close-modal" (click)="fecharModalEdicao()">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="modal-body" *ngIf="custoSelecionado">
      <form>
        <div class="mb-3">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control" [(ngModel)]="custoSelecionado.descricao" name="descricao">
        </div>
        <div class="mb-3">
          <label class="form-label">Valor</label>
          <input type="number" class="form-control" [(ngModel)]="custoSelecionado.valor" name="valor" step="0.01">
        </div>
        <div class="mb-3">
          <label class="form-label">Data de Pagamento</label>
          <input type="date" class="form-control" [(ngModel)]="custoSelecionado.dataPagamento" name="dataPagamento">
        </div>
        <div class="mb-3">
          <label class="form-label">Categoria</label>
          <select class="form-select" [(ngModel)]="custoSelecionado.temaCustoId" name="temaCustoId">
            <option *ngFor="let tema of temas" [ngValue]="tema.id">{{ tema.nome }}</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModalEdicao()">
        <span class="material-icons">close</span> Cancelar
      </button>
      <button class="btn btn-primary" (click)="salvarEdicao()" [disabled]="loading">
        <span class="material-icons">save</span> Salvar
      </button>
    </div>
  </div>
</div>
