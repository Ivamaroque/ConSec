<div class="dashboard-layout">
  <!-- Sidebar ESQUERDA - Menu de Navegação -->
  <app-sidebar activePage="dashboard"></app-sidebar>

  <!-- Área CENTRAL - Dashboard Principal -->
  <main class="dashboard-main">
    <div class="main-header">
      <h4>Dashboard</h4>
      <div class="header-filters">
        <span>Mês:</span>
        <select class="form-select form-select-sm" [(ngModel)]="mesSelecionado" (change)="onMesAnoChange()">
          <option *ngFor="let mes of meses" [value]="mes.valor">{{ mes.nome }}</option>
        </select>
        <span>Ano:</span>
        <select class="form-select form-select-sm" [(ngModel)]="anoSelecionado" (change)="onMesAnoChange()">
          <option *ngFor="let ano of anos" [value]="ano">{{ ano }}</option>
        </select>
      </div>
    </div>

    <!-- Mensagem de erro -->
    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
      {{ errorMessage }}
      <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
    </div>

    <!-- Cards de Resumo -->
    <div class="summary-cards" *ngIf="resumo">
      <div class="summary-card saldo">
        <div class="summary-card-icon">
          <span class="material-icons">account_balance_wallet</span>
        </div>
        <div class="summary-card-content">
          <div class="summary-card-header">Saldo Total</div>
          <div class="summary-card-value">{{ formatCurrency(saldoTotal) }}</div>
        </div>
      </div>
      
      <div class="summary-card custo">
        <div class="summary-card-icon">
          <span class="material-icons">trending_down</span>
        </div>
        <div class="summary-card-content">
          <div class="summary-card-header">Custo Total</div>
          <div class="summary-card-value">{{ formatCurrency(resumo.totalGeral) }}</div>
        </div>
      </div>
      
      <div class="summary-card disponivel" 
           [class.positivo]="statusDisponivel === 'positivo'"
           [class.alerta]="statusDisponivel === 'alerta'"
           [class.negativo]="statusDisponivel === 'negativo'">
        <div class="summary-card-icon">
          <span class="material-icons">
            {{ statusDisponivel === 'negativo' ? 'error' : statusDisponivel === 'alerta' ? 'warning' : 'check_circle' }}
          </span>
        </div>
        <div class="summary-card-content">
          <div class="summary-card-header">Disponível</div>
          <div class="summary-card-value">{{ formatCurrency(totalDisponivel) }}</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section mb-4">
      <h6 class="mb-3">Visualizar por Mês:</h6>
      <div class="d-flex gap-3 align-items-end">
        <div>
          <label class="form-label small">Data Início</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="filtros.dataInicio">
        </div>
        <div>
          <label class="form-label small">Data Fim</label>
          <input type="date" class="form-control form-control-sm" [(ngModel)]="filtros.dataFim">
        </div>
        <div>
          <label class="form-label small">Categoria</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.temaCustoId">
            <option [ngValue]="null">Todas</option>
            <option *ngFor="let tema of temas" [ngValue]="tema.id">{{ tema.nome }}</option>
          </select>
        </div>
        <div>
          <label class="form-label small">Ano</label>
          <select class="form-select form-select-sm">
            <option>2025</option>
          </select>
        </div>
        <button class="btn btn-primary btn-sm" (click)="aplicarFiltros()" [disabled]="loading">
          <span class="material-icons">search</span> Filtrar
        </button>
        <button class="btn btn-outline-secondary btn-sm" (click)="limparFiltros()" [disabled]="loading">
          <span class="material-icons">cancel</span> Limpar
        </button>
      </div>
    </div>

    <!-- Gráficos linha 1: Gastos por Categoria e Gastos por Mês -->
    <div class="charts-grid" *ngIf="resumo">
      <!-- Gráfico de Pizza - Gastos por Categoria -->
      <div class="chart-section">
        <h6 class="mb-3"><span class="material-icons">pie_chart</span> Gastos por Categoria</h6>
        <div class="pie-chart-container">
          <div *ngIf="resumoAnual && resumoAnual.porTema && resumoAnual.porTema.length > 0" class="pie-chart-wrapper">
            <canvas #pieChartCanvas></canvas>
          </div>
          <div *ngIf="!resumoAnual || !resumoAnual.porTema || resumoAnual.porTema.length === 0" class="text-center text-muted">
            <span class="material-icons fs-1">pie_chart</span>
            <p class="mt-2">Nenhum dado disponível</p>
          </div>
        </div>
      </div>

      <!-- Gráfico de Linha - Histórico Mensal -->
      <div class="chart-section">
        <h6 class="mb-3"><span class="material-icons">show_chart</span> Gastos por Mês</h6>
        <div class="line-chart-container">
          <div *ngIf="resumoAnual && resumoAnual.porMes && resumoAnual.porMes.length > 0" class="line-chart-wrapper">
            <canvas #lineChartCanvas></canvas>
          </div>
          <div *ngIf="!resumoAnual || !resumoAnual.porMes || resumoAnual.porMes.length === 0" class="text-center text-muted">
            <span class="material-icons fs-1">show_chart</span>
            <p class="mt-2">Nenhum dado disponível</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico linha 2: Gastos por Dia do Mês (destaque) -->
    <div class="chart-section-full mb-4" *ngIf="resumo">
      <h6 class="mb-3"><span class="material-icons">bar_chart</span> Gastos por Dia do Mês</h6>
      <div class="bar-chart-container">
        <div *ngIf="gastoPorDia.length > 0" class="bar-chart-wrapper">
          <canvas #barChartCanvas></canvas>
        </div>
        <div *ngIf="gastoPorDia.length === 0" class="text-center text-muted">
          <span class="material-icons fs-1">bar_chart</span>
          <p class="mt-2">Nenhum dado disponível</p>
        </div>
      </div>
    </div>

    <!-- Gráfico de Funcionários -->
    <div class="chart-section mb-4" *ngIf="resumo">
      <h6 class="mb-3"><span class="material-icons">people</span> Gastos por Funcionário</h6>
      <div *ngIf="resumo.porUsuario.length > 0" class="table-responsive">
        <table class="table table-hover table-sm mb-0">
          <thead>
            <tr>
              <th>Funcionário</th>
              <th class="text-end">Total</th>
              <th class="text-end">Quantidade</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of resumo.porUsuario">
              <td><span class="material-icons">account_circle</span> {{ usuario.usuarioNome }}</td>
              <td class="text-end fw-bold">{{ formatCurrency(usuario.total) }}</td>
              <td class="text-end"><span class="badge bg-secondary">{{ usuario.quantidade }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="resumo.porUsuario.length === 0" class="text-center text-muted py-3">
        <p>Nenhum funcionário com gastos</p>
      </div>
    </div>
  </main>

  <!-- Sidebar DIREITA - Últimos Gastos -->
  <aside class="sidebar-right">
    <h6 class="sidebar-title">
      <span class="material-icons">receipt_long</span> Últimos gastos adicionados
    </h6>

    <div *ngIf="loading" class="text-center py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
    </div>

    <div *ngIf="!loading && custos.length === 0" class="text-center text-muted py-3">
      <small>Nenhum custo encontrado</small>
    </div>

    <div *ngIf="!loading && custos.length > 0" class="expense-list">
      <div *ngFor="let custo of custos.slice(0, 10)"
           class="expense-card">
        <!-- Aplicar cor dinamicamente -->
        <div class="expense-card-border" [style.background-color]="custo.temaCustoCor || '#667eea'"></div>
        <div class="expense-card-header">
          <div class="expense-tema-info">
            <span class="expense-tema" [style.color]="custo.temaCustoCor || '#667eea'">{{ custo.temaCustoNome }}</span>
            <span class="expense-separator">|</span>
            <span class="expense-author">{{ custo.usuarioNome || 'Não informado' }}</span>
          </div>
          <div class="expense-date">{{ formatDate(custo.dataPagamento) }}</div>
        </div>

        <div class="expense-card-body">
          <div class="expense-title">{{ custo.descricao }}</div>
          <div class="expense-price">{{ formatCurrency(custo.valor) }}</div>
        </div>

        <div class="expense-card-footer">
          <a *ngIf="custo.arquivoAnexoPath" (click)="downloadComprovante(custo)" class="expense-link clickable">
            <span class="material-icons clickable">insert_drive_file</span>
            Comprovante.{{ getFileExtension(custo.arquivoAnexoPath) }}
          </a>
          <span *ngIf="!custo.arquivoAnexoPath" class="expense-no-attachment">
            <span class="material-icons">description</span>
            Sem comprovante
          </span>
          <div class="expense-actions-icons" *ngIf="isAdmin">
            <button class="btn-icon-small clickable" title="Editar" (click)="abrirModalEdicao(custo)">
              <span class="material-icons clickable">edit</span>
            </button>
            <button class="btn-icon-small btn-icon-delete clickable" title="Excluir" (click)="abrirModalExclusao(custo)">
              <span class="material-icons clickable">delete</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- Modal de Exclusão -->
<div class="modal-overlay clickable" *ngIf="showDeleteModal" (click)="fecharModalExclusao()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5><span class="material-icons">delete</span> Confirmar Exclusão</h5>
      <button class="btn-close-modal clickable" (click)="fecharModalExclusao()">
        <span class="material-icons clickable">close</span>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir este custo?</p>
      <div class="delete-info" *ngIf="custoSelecionado">
        <strong>{{ custoSelecionado.descricao }}</strong>
        <p class="text-muted">{{ formatCurrency(custoSelecionado.valor) }}</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary clickable" (click)="fecharModalExclusao()">
        <span class="material-icons">close</span> Cancelar
      </button>
      <button class="btn btn-danger clickable" (click)="confirmarExclusao()" [disabled]="loading">
        <span class="material-icons">delete</span> Excluir
      </button>
    </div>
  </div>
</div>

<!-- Modal de Edição -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="fecharModalEdicao()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5><span class="material-icons">edit</span> Editar Custo</h5>
      <button class="btn-close-modal" (click)="fecharModalEdicao()">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="modal-body" *ngIf="custoSelecionado">
      <form>
        <div class="mb-3">
          <label class="form-label">Descrição</label>
          <input type="text" class="form-control" [(ngModel)]="custoSelecionado.descricao" name="descricao">
        </div>
        <div class="mb-3">
          <label class="form-label">Valor</label>
          <input type="text" class="form-control" [(ngModel)]="custoSelecionado.valor" name="valor" appCurrencyMask>
        </div>
        <div class="mb-3">
          <label class="form-label">Data de Pagamento</label>
          <input type="date" class="form-control" [(ngModel)]="custoSelecionado.dataPagamento" name="dataPagamento">
        </div>
        <div class="mb-3">
          <label class="form-label">Categoria</label>
          <select class="form-select" [(ngModel)]="custoSelecionado.temaCustoId" name="temaCustoId">
            <option *ngFor="let tema of temas" [ngValue]="tema.id">{{ tema.nome }}</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModalEdicao()">
        <span class="material-icons">close</span> Cancelar
      </button>
      <button class="btn btn-primary" (click)="salvarEdicao()" [disabled]="loading">
        <span class="material-icons">save</span> Salvar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Detalhes do Dia -->
<div class="modal-overlay" *ngIf="showDayDetailModal" (click)="fecharDetalheDia()">
  <div class="modal-content modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5>
        <span class="material-icons">calendar_today</span> 
        Detalhes do Dia {{ diaDetalhadoData?.dia }}
      </h5>
      <button class="btn-close-modal" (click)="fecharDetalheDia()">
        <span class="material-icons">close</span>
      </button>
    </div>
    <div class="modal-body" *ngIf="diaDetalhadoData">
      <div class="day-detail-summary">
        <div class="day-detail-total">
          <span class="material-icons">attach_money</span>
          <div>
            <small>Total do Dia</small>
            <h4>{{ formatCurrency(diaDetalhadoData.total) }}</h4>
          </div>
        </div>
      </div>

      <h6 class="mt-4 mb-3">
        <span class="material-icons">category</span> 
        Gastos por Categoria
      </h6>

      <div class="temas-list">
        <div *ngFor="let tema of diaDetalhadoData.temas" class="tema-item">
          <div class="tema-info">
            <div class="tema-color-indicator" [style.background-color]="tema.cor"></div>
            <div class="tema-details">
              <strong>{{ tema.nome }}</strong>
              <div class="tema-percentage">
                {{ ((tema.valor / diaDetalhadoData.total) * 100).toFixed(1) }}% do total
              </div>
            </div>
          </div>
          <div class="tema-value">
            {{ formatCurrency(tema.valor) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
